version: 2.1
executors:
  default-executor:
    docker:
      - image: cypress/base:10
jobs:
  set-up-dependencies:
    executor: default-executor
    steps:
      - checkout
      - run:
          name: Set more environment variables
          command: |-
            echo 'export CIRCLE_SHA1=$(git rev-parse HEAD)' >> $BASH_ENV
            echo 'export CIRCLE_BRANCH=$(git rev-parse --abbrev-ref HEAD)' >> $BASH_ENV
      - run:
          name: Restore cache
          command: >
            if [ $(ls -l /tmp/local-ci | awk '{print $3}') != $(whoami) ]
              then
              sudo chown $(whoami) /tmp/local-ci
            fi
            restore_from_directories=("/tmp/local-ci/v2-deps-$( if [ -f "package-lock.json" ]; then shasum "package-lock.json" | awk '{print $1}'; fi )*/.npm" "/tmp/local-ci/v2-deps*/.npm")
              for directory_candidate in $restore_from_directories
                do
                if [ $(ls -ard $directory_candidate 2>/dev/null) ]
                  then
                  verified_directory=$(ls -ard $directory_candidate | tail -n1)
                  echo "Restoring cached directory $verified_directory";
                  cp -rn $verified_directory ~ || cp -ru $verified_directory ~;
                  break;
                fi
              done;
            restore_from_directories=("/tmp/local-ci/v2-deps-$( if [ -f "package-lock.json" ]; then shasum "package-lock.json" | awk '{print $1}'; fi )*/.cache" "/tmp/local-ci/v2-deps*/.cache")
              for directory_candidate in $restore_from_directories
                do
                if [ $(ls -ard $directory_candidate 2>/dev/null) ]
                  then
                  verified_directory=$(ls -ard $directory_candidate | tail -n1)
                  echo "Restoring cached directory $verified_directory";
                  cp -rn $verified_directory ~ || cp -ru $verified_directory ~;
                  break;
                fi
              done;
      - run:
          name: Install dependencies
          command: npm ci
      - run:
          name: Save cache
          command: |2
             if [ -d /tmp/local-ci/v2-deps-$( if [ -f "package-lock.json" ]; then shasum "package-lock.json" | awk '{print $1}'; fi )/.npm ]
                  then
                  echo "~/.npm is already cached, skipping"
                elif [ ! -d ~/.npm ]
                  then
                  echo "~/.npm does not exist, skipping caching"
                else
                  echo "Saving ~/.npm to the cache"
                  mkdir -p /tmp/local-ci/v2-deps-$( if [ -f "package-lock.json" ]; then shasum "package-lock.json" | awk '{print $1}'; fi )
                  cp -rn ~/.npm /tmp/local-ci/v2-deps-$( if [ -f "package-lock.json" ]; then shasum "package-lock.json" | awk '{print $1}'; fi )/.npm || cp -ru ~/.npm /tmp/local-ci/v2-deps-$( if [ -f "package-lock.json" ]; then shasum "package-lock.json" | awk '{print $1}'; fi )/.npm
                fi
             if [ -d /tmp/local-ci/v2-deps-$( if [ -f "package-lock.json" ]; then shasum "package-lock.json" | awk '{print $1}'; fi )/.cache ]
                  then
                  echo "~/.cache is already cached, skipping"
                elif [ ! -d ~/.cache ]
                  then
                  echo "~/.cache does not exist, skipping caching"
                else
                  echo "Saving ~/.cache to the cache"
                  mkdir -p /tmp/local-ci/v2-deps-$( if [ -f "package-lock.json" ]; then shasum "package-lock.json" | awk '{print $1}'; fi )
                  cp -rn ~/.cache /tmp/local-ci/v2-deps-$( if [ -f "package-lock.json" ]; then shasum "package-lock.json" | awk '{print $1}'; fi )/.cache || cp -ru ~/.cache /tmp/local-ci/v2-deps-$( if [ -f "package-lock.json" ]; then shasum "package-lock.json" | awk '{print $1}'; fi )/.cache
                fi
      - run:
          name: Persist to workspace
          command: cp -rn . /tmp/local-ci || cp -ru . /tmp/local-ci
  run-prettier:
    executor: default-executor
    steps:
      - run:
          name: Attach workspace
          command: |-
            if [ ! -d /tmp/local-ci ]
              then
                echo "Warning: tried to attach_workspace to /tmp/local-ci, but it's not a directory. It might require a job to run before it."
              elif [ ! "$(ls -A /tmp/local-ci)" ]
                then
                echo "Warning: tried to attach_workspace to /tmp/local-ci, but it's empty. It might require a job to run before it."
              else
                cp -rn /tmp/local-ci/. . || cp -ru /tmp/local-ci/. .
              fi
      - run:
          name: Run prettier check on project files
          command: npm run prettier:check
      - run:
          name: Save cache
          command: |2
            if [ -d /tmp/local-ci/node-modules-$( if [ -f "package-lock.json" ]; then shasum "package-lock.json" | awk '{print $1}'; fi )/node_modules ]
              then
              echo "node_modules is already cached, skipping"
            elif [ ! -d node_modules ]
              then
              echo "node_modules does not exist, skipping caching"
            else
              echo "Saving node_modules to the cache"
              mkdir -p /tmp/local-ci/node-modules-$( if [ -f "package-lock.json" ]; then shasum "package-lock.json" | awk '{print $1}'; fi )
              cp -rn node_modules /tmp/local-ci/node-modules-$( if [ -f "package-lock.json" ]; then shasum "package-lock.json" | awk '{print $1}'; fi )/node_modules || cp -ru node_modules /tmp/local-ci/node-modules-$( if [ -f "package-lock.json" ]; then shasum "package-lock.json" | awk '{print $1}'; fi )/node_modules
            fi
  run-linter:
    executor: default-executor
    steps:
      - run:
          name: Attach workspace
          command: |-
            if [ ! -d /tmp/local-ci ]
            then
              echo "Warning: tried to attach_workspace to /tmp/local-ci, but it's not a directory. It might require a job to run before it."
            elif [ ! "$(ls -A /tmp/local-ci)" ]
              then
              echo "Warning: tried to attach_workspace to /tmp/local-ci, but it's empty. It might require a job to run before it."
            else
              cp -rn /tmp/local-ci/. . || cp -ru /tmp/local-ci/. .
            fi
      - run:
          name: Run linter
          command: npm run lint
  run-unit-tests:
    executor: default-executor
    steps:
      - run:
          name: Attach workspace
          command: |-
            if [ ! -d /tmp/local-ci ]
            then
              echo "Warning: tried to attach_workspace to /tmp/local-ci, but it's not a directory. It might require a job to run before it."
            elif [ ! "$(ls -A /tmp/local-ci)" ]
              then
              echo "Warning: tried to attach_workspace to /tmp/local-ci, but it's empty. It might require a job to run before it."
            else
              cp -rn /tmp/local-ci/. . || cp -ru /tmp/local-ci/. .
            fi
      - run:
          name: Run unit tests
          command: npm run test:unit
  e2e-tests:
    executor: default-executor
    steps:
      - run:
          name: Attach workspace
          command: |-
            if [ ! -d /tmp/local-ci ]
            then
              echo "Warning: tried to attach_workspace to /tmp/local-ci, but it's not a directory. It might require a job to run before it."
            elif [ ! "$(ls -A /tmp/local-ci)" ]
              then
              echo "Warning: tried to attach_workspace to /tmp/local-ci, but it's empty. It might require a job to run before it."
            else
              cp -rn /tmp/local-ci/. . || cp -ru /tmp/local-ci/. .
            fi
      - run:
          name: Restore cache
          command: >
            if [ $(ls -l /tmp/local-ci | awk '{print $3}') != $(whoami) ]
              then
              sudo chown $(whoami) /tmp/local-ci
            fi
            restore_from_directories=("/tmp/local-ci/v2-deps-$( if [ -f "package-lock.json" ]; then shasum "package-lock.json" | awk '{print $1}'; fi )*/.npm" "/tmp/local-ci/v2-deps*/.npm" "/tmp/local-ci/node-modules-$( if [ -f "package-lock.json" ]; then shasum "package-lock.json" | awk '{print $1}'; fi )*/.npm")
            for directory_candidate in $restore_from_directories
              do
              if [ $(ls -ard $directory_candidate 2>/dev/null) ]
                then
                verified_directory=$(ls -ard $directory_candidate | tail -n1)
                echo "Restoring cached directory $verified_directory";
                cp -rn $verified_directory ~ || cp -ru $verified_directory ~;
                break;
              fi
            done;
            if [ $(ls -l /tmp/local-ci | awk '{print $3}') != $(whoami) ]
              then
              sudo chown $(whoami) /tmp/local-ci
            fi
            restore_from_directories=("/tmp/local-ci/v2-deps-$( if [ -f "package-lock.json" ]; then shasum "package-lock.json" | awk '{print $1}'; fi )*/.cache" "/tmp/local-ci/v2-deps*/.cache" "/tmp/local-ci/node-modules-$( if [ -f "package-lock.json" ]; then shasum "package-lock.json" | awk '{print $1}'; fi )*/.cache")
            for directory_candidate in $restore_from_directories
              do
              if [ $(ls -ard $directory_candidate 2>/dev/null) ]
                then
                verified_directory=$(ls -ard $directory_candidate | tail -n1)
                echo "Restoring cached directory $verified_directory";
                cp -rn $verified_directory ~ || cp -ru $verified_directory ~;
                break;
              fi
            done;
      - run:
          name: Run e2e tests
          command: npm run test:e2e:headless
  build:
    executor: default-executor
    steps:
      - run:
          name: Attach workspace
          command: |-
            if [ ! -d /tmp/local-ci ]
            then
              echo "Warning: tried to attach_workspace to /tmp/local-ci, but it's not a directory. It might require a job to run before it."
            elif [ ! "$(ls -A /tmp/local-ci)" ]
              then
              echo "Warning: tried to attach_workspace to /tmp/local-ci, but it's empty. It might require a job to run before it."
            else
              cp -rn /tmp/local-ci/. . || cp -ru /tmp/local-ci/. .
            fi
      - run:
          name: Build
          command: npm run build
      - run:
          name: Persist to workspace
          command: cp -rn . /tmp/local-ci || cp -ru . /tmp/local-ci
  verify-bundles-sizes:
    executor: default-executor
    steps:
      - run:
          name: Attach workspace
          command: |-
            if [ ! -d /tmp/local-ci ]
            then
              echo "Warning: tried to attach_workspace to /tmp/local-ci, but it's not a directory. It might require a job to run before it."
            elif [ ! "$(ls -A /tmp/local-ci)" ]
              then
              echo "Warning: tried to attach_workspace to /tmp/local-ci, but it's empty. It might require a job to run before it."
            else
              cp -rn /tmp/local-ci/. . || cp -ru /tmp/local-ci/. .
            fi
      - run:
          name: Check bundles sizes
          command: npm run bundlesize
  deploy:
    executor: default-executor
    steps:
      - run:
          name: Attach workspace
          command: |-
            if [ ! -d /tmp/local-ci ]
            then
              echo "Warning: tried to attach_workspace to /tmp/local-ci, but it's not a directory. It might require a job to run before it."
            elif [ ! "$(ls -A /tmp/local-ci)" ]
              then
              echo "Warning: tried to attach_workspace to /tmp/local-ci, but it's empty. It might require a job to run before it."
            else
              cp -rn /tmp/local-ci/. . || cp -ru /tmp/local-ci/. .
            fi
      - run:
          name: Firebase deploy
          command: |
            if [[ "$CIRCLE_BRANCH" == "master" ]]
              then
              npm run firebase:deploy:ci
            fi
workflows:
  version: 2
  build-and-deploy:
    jobs:
      - set-up-dependencies
      - run-prettier:
          requires:
            - set-up-dependencies
      - run-linter:
          requires:
            - set-up-dependencies
      - run-unit-tests:
          requires:
            - set-up-dependencies
      - e2e-tests:
          requires:
            - set-up-dependencies
      - build:
          requires:
            - run-prettier
            - run-linter
            - run-unit-tests
            - e2e-tests
      - verify-bundles-sizes:
          requires:
            - build
      - deploy:
          requires:
            - verify-bundles-sizes
